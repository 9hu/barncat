#!/bin/bash

#  _._     _,-'""`-._
# (,-.`._,'(       |\`-/|  barncat
#     `-.-' \ )-`( , o o)
# -bf-      `-    \`_`"'-

done="\033[0;32mdone\033[0m"
error="\033[0;31merror\033[0m"

printf "reading config.sh... "
source ./config.sh
printf "$done\n"

function print_commands {
  printf "./barncat <command>\n\n"
  printf "  build    generate only modified parts of input, removing nothing\n"
  printf "  rebuild  generate entire website from input, purging all beforehand\n"
}

function generate-vars {
  stripped="$(echo $1 | sed "s|$input||g ; s|$markdown_ext|$html_ext|g")"
  url="/$stripped"
  html="$output$stripped"
  sed_title="s|{{ title }}|sample title template thing|g"
  sed_creation="$(echo "s|{{ creation date }}|$(stat -c %y $1 | sed 's/\s.*$//')|g")"
  sed_modified="$(echo "s|{{ modified date }}|$(stat -c %y $1 | sed 's/\s.*$//')|g")"
  sed_string="$sed_title ; $sed_creation ; $sed_modified"
}

function generate-page { # $1 = layout file
  generate-vars $file
  if [ "$file" -nt "$html" ] ; then
    temp=$(mktemp)
    cat "$layouts$1" > $html
    sed -i "$sed_string" $html
    eval $markdown_converter $file > $temp
    sed -e '/{{ content }}/ {' -e "r $temp" -e 'd' -e '}' -i $html
    eval $html_cleanup $html
  fi
}

function build-site {
  for dir in $output $cache ; do 
    if [ ! -d $dir ] ; then 
      mkdir $dir ; 
    fi 
  done
  # duplidate directory structure, if it doesn't already exist
  (cd $input && find . -type d -exec mkdir -p ../$output{} \;)
  for path in "${!layout[@]}" ; do 
    for file in $(find -type f -wholename "$input$path*$markdown_ext") ; do
      generate-page ${layout[$path]}
    done
  done
  for file in $(find -type f -wholename "$input*") ; do
    if [[ $file == *$markdown_ext ]] ; then
      generate-page $mdfile default.html
    else
      output_file="$(echo $file | sed "s|$input|$output|g")"
      if [ "$file" -nt "$output_file" ] ; then
        cp $file $output_file
      fi
    fi
  done
}

function clear-site { # purge the cache, purge the site
  printf "purging output + cache... "
  rm -f -r $output* $cache*
  printf "$done\n"
}

case "$1" in
	build) build-site ;;
	rebuild) clear-site ; build-site ;;
	*) print_commands ;;

esac
